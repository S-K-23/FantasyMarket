generator client {
  provider = "prisma-client" // Prisma 7 client
  output   = "../lib/generated/client"
}

datasource db {
  provider  = "postgresql"
}

model League {
  id              Int      @id @default(autoincrement())
  leagueId        String   @unique // On-chain PDA address or ID
  name            String
  creator         String   // Pubkey
  buyIn           Float
  currency        String   // SOL or USDC
  maxPlayers      Int
  currentPlayers  Int      @default(0)
  status          String   // SETUP, DRAFTING, ACTIVE, COMPLETED
  currentSession  Int      @default(1)
  totalSessions   Int
  marketsPerSession Int    @default(5)
  category        String?  // Market category filter (Sports, Politics, Crypto, etc.)
  draftOrder      String[] @default([]) // Array of player addresses in draft order
  createdAt       DateTime @default(now())
  
  players         PlayerStats[]
  draftPicks      DraftPick[]
}

model PlayerStats {
  id        Int     @id @default(autoincrement())
  leagueId  Int
  league    League  @relation(fields: [leagueId], references: [id])
  address   String  // Pubkey
  points    Float   @default(0)
  streak    Int     @default(0)
  rank      Int?
  
  @@unique([leagueId, address])
}

model Market {
  id              String    @id // Polymarket Market ID
  title           String
  description     String?
  category        String
  p0              Float?    // Initial probability
  resolution      String?   // YES, NO, INVALID
  resolvedAt      DateTime?
  
  // Polymarket Data
  endDate         DateTime
  currentPriceYes Float?
  currentPriceNo  Float?
  liquidity       Float?
  volume          Float?
  tokenIdYes      String?
  tokenIdNo       String?
  tickSize        Decimal?  @db.Decimal(8, 6)
  negRisk         Boolean   @default(false)
  active          Boolean   @default(true)
  polymarketUrl   String?

  draftPicks      DraftPick[]
}

model DraftPick {
  id            Int      @id @default(autoincrement())
  leagueId      Int
  league        League   @relation(fields: [leagueId], references: [id])
  marketId      String
  market        Market   @relation(fields: [marketId], references: [id])
  player        String   // Pubkey
  prediction    String   // YES or NO
  session       Int
  pickIndex     Int
  snapshotOdds  Int?     // Probability at draft time (basis points, e.g., 5000 = 50%)
  points        Float?
  isResolved    Boolean  @default(false)
  
  @@unique([leagueId, marketId, prediction])
}
model Trade {
  id            String   @id @default(uuid())
  tradeId       String   // On-chain Trade ID (u64 as string)
  leagueId      Int
  league        League   @relation(fields: [leagueId], references: [id])
  proposer      String   // Pubkey
  receiver      String   // Pubkey
  proposerPick  Int      // DraftPick ID (DB ID)
  receiverPick  Int      // DraftPick ID (DB ID)
  status        String   // PENDING, ACCEPTED, REJECTED, EXPIRED, CANCELED
  createdAt     DateTime @default(now())
  expiresAt     DateTime
  
  @@unique([leagueId, tradeId])
}
